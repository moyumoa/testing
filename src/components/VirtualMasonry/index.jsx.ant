import React, { useCallback, useEffect, useRef, useState } from "react"
import { Spin, Empty, Button, Divider } from "antd"

// === å¸¸é‡å®šä¹‰ ===
const GUTTER = 16 // å®¹å™¨è¾¹è·
const VIEWPORT_BUFFER = 1000 // é¢„åŠ è½½ç¼“å†²åŒºï¼ˆä¸Š/ä¸‹å„ 1000pxï¼‰
const VERTICAL_GAP = 16 // åž‚ç›´é—´è·
const HORIZONTAL_GAP = 16 // æ°´å¹³é—´è·
const MAX_REMOVED_ITEMS = 2000 // ç§»é™¤ä¸Šé™ï¼Œè¶…è¿‡å°±æ‰§è¡Œå½»åº•æ¸…ç†

export default function VirtualWaterfall({
  fetchPage, // å¼‚æ­¥åˆ†é¡µåŠ è½½å‡½æ•°
  getItemId, // èŽ·å– item å”¯ä¸€æ ‡è¯†çš„å‡½æ•°
  renderItem, // æ¸²æŸ“å•ä¸ª item çš„ç»„ä»¶
  pageSize = 20,
  columnCount = 4,
  defaultParams = {},
  style = {},
}) {
  const containerRef = useRef(null) // å®¹å™¨ DOM å¼•ç”¨
  const [containerWidth, setContainerWidth] = useState(0)
  const [scrollTop, setScrollTop] = useState(0) // å½“å‰æ»šåŠ¨ä½ç½®
  const [viewportHeight, setViewportHeight] = useState(window.innerHeight)
  const [, forceRerender] = useState(0) // å¼ºåˆ¶åˆ·æ–°ç”¨

  const heightMap = useRef({}) // item é«˜åº¦æ˜ å°„
  const itemsRef = useRef([]) // æ‰€æœ‰å·²åŠ è½½çš„æ•°æ®é¡¹
  const removedIds = useRef(new Set()) // è¢«â€œè½¯åˆ é™¤â€çš„ id é›†åˆ
  const loadingRef = useRef(false) // é˜²æ­¢å¹¶å‘åŠ è½½
  const [isLoading, setIsLoading] = useState(false)
  const [hasMore, setHasMore] = useState(true)
  const [nextCursor, setNextCursor] = useState(null) // æ¸¸æ ‡åˆ†é¡µç”¨
  const [isInitialLoading, setIsInitialLoading] = useState(true)

  // === è®¡ç®—åˆ—å®½ ===
  const columnWidth =
    (containerWidth - (columnCount - 1) * HORIZONTAL_GAP) / columnCount

  // === è½¯åˆ é™¤å‡½æ•° ===
  const removeItem = useCallback(
    (id) => {
      removedIds.current.add(id)
      forceRerender((n) => n + 1)

      if (removedIds.current.size > MAX_REMOVED_ITEMS) {
        // ðŸ‘‰ è¶…å‡ºä¸Šé™ï¼Œè§¦å‘å½»åº•æ¸…ç†
        itemsRef.current = itemsRef.current.filter(
          (i) => !removedIds.current.has(getItemId(i))
        )
        console.log("ðŸ§¹ æ‰§è¡Œå½»åº•æ¸…ç†", removedIds.current)

        heightMap.current = Object.fromEntries(
          Object.entries(heightMap.current).filter(
            ([key]) => !removedIds.current.has(key)
          )
        )
        console.log("ðŸ§¹ æ‰§è¡Œç¼“å­˜æ¸…ç†", removedIds.current)
        removedIds.current.clear()
      }
    },
    [getItemId]
  )

  // === åŠ è½½æ›´å¤šæ•°æ® ===
  const loadMore = useCallback(async () => {
    if (!hasMore || loadingRef.current) return

    loadingRef.current = true
    setIsLoading(true)

    try {
      const lastItem = nextCursor || itemsRef.current.at(-1)
      const res = await fetchPage({
        limit: pageSize,
        ...defaultParams,
        ...(lastItem && {
          clt: lastItem.create_time,
          cli: lastItem._id,
        }),
      })

      const list = res?.data?.rows || res?.data?.list || res?.data || []
      if (list.length < pageSize) setHasMore(false)

      itemsRef.current.push(...list)
      forceRerender((n) => n + 1)

      if (res?.next_cursor) {
        setNextCursor(res.next_cursor)
      }
    } finally {
      loadingRef.current = false
      setIsLoading(false)
      setIsInitialLoading(false)
    }
  }, [fetchPage, pageSize, defaultParams, hasMore, nextCursor])

  // === å‚æ•°å˜åŒ–æ—¶ï¼Œæ¸…ç©ºæ•°æ®é‡æ–°åŠ è½½ ===
  const previousParams = useRef(JSON.stringify(defaultParams))
  useEffect(() => {
    const newParams = JSON.stringify(defaultParams)
    if (previousParams.current !== newParams) {
      previousParams.current = newParams
      itemsRef.current = []
      heightMap.current = {}
      removedIds.current.clear()
      loadingRef.current = false
      setHasMore(true)
      setNextCursor(null)
      forceRerender((n) => n + 1)
      loadMore()
    }
  }, [defaultParams, loadMore])

  // === å®¹å™¨å°ºå¯¸å˜åŒ–ç›‘å¬ ===
  useEffect(() => {
    const resizeObserver = new ResizeObserver(([entry]) => {
      setContainerWidth(entry.contentRect.width)
    })
    if (containerRef.current) {
      resizeObserver.observe(containerRef.current)
    }
    return () => resizeObserver.disconnect()
  }, [])

  // === ç§»é™¤å·²åˆ é™¤é¡¹ï¼Œæž„å»ºæœ‰æ•ˆ item åˆ—è¡¨ ===
  const allItems = itemsRef.current.filter(
    (i) => !removedIds.current.has(getItemId(i))
  )

  // === æž„å»º item çš„ç»å¯¹å®šä½ä¿¡æ¯ ===
  const cols = Array.from({ length: columnCount }, () => 0)
  const positionedItems = useRef([])
  positionedItems.current = allItems.map((item) => {
    const id = getItemId(item)
    const height = heightMap.current[id] || item.height || 0 // é»˜è®¤é«˜åº¦ä¸º 0ï¼Œé¿å…é”™ä½
    const col = cols.indexOf(Math.min(...cols))
    const top = cols[col]
    const left = col * (columnWidth + HORIZONTAL_GAP)
    cols[col] += height + VERTICAL_GAP
    return {
      ...item,
      _id: id,
      top,
      left,
      height,
      originalHeight: item.height,
      originalWidth: item.width,
    }
  })

  const containerHeight = Math.max(...cols, 0)

  // === ç­›é€‰å½“å‰å¯è§†åŒºåŸŸçš„ item ===
  const visibleItems = positionedItems.current.filter(
    (i) =>
      i.top + i.height >= scrollTop - VIEWPORT_BUFFER &&
      i.top <= scrollTop + viewportHeight + VIEWPORT_BUFFER
  )

  // === å½“å‰æ˜¯å¦éœ€è¦æ‰‹åŠ¨åŠ è½½æ›´å¤šï¼ˆå†…å®¹ä¸å¤Ÿå¡«æ»¡ï¼‰ ===
  const canManuallyLoadMore =
    hasMore && !isLoading && containerHeight < viewportHeight

  // === ç›‘å¬æ»šåŠ¨è§¦å‘æ‡’åŠ è½½ ===
  useEffect(() => {
    const el = containerRef.current
    if (!el) return
    let ticking = false
    const onScroll = () => {
      if (!ticking) {
        requestAnimationFrame(() => {
          const y = el.scrollTop
          setScrollTop(y)
          setViewportHeight(el.clientHeight)

          const lastItem = positionedItems.current.at(-1)
          if (
            hasMore &&
            lastItem &&
            lastItem.top < y + el.clientHeight + VIEWPORT_BUFFER
          ) {
            loadMore()
          }

          ticking = false
        })
        ticking = true
      }
    }
    el.addEventListener("scroll", onScroll)
    return () => el.removeEventListener("scroll", onScroll)
  }, [loadMore, hasMore])

  // === åˆå§‹åŠ è½½ ===
  useEffect(() => {
    if (containerWidth > 0 && allItems.length === 0) {
      loadMore()
    }
  }, [containerWidth, loadMore, allItems.length])

  // === ç®€åŒ–åŽçš„é«˜åº¦æµ‹é‡ ===
  const measureItem = (id, node) => {
    if (!node) return
    requestAnimationFrame(() => {
      const h = node.offsetHeight
      if (heightMap.current[id] !== h) {
        heightMap.current[id] = h
        forceRerender((n) => n + 1)
      }
    })
  }

  // === æ¸²æŸ“ ===
  return (
    <section
      ref={containerRef}
      style={{
        height: "100%",
        overflowY: "auto",
        boxSizing: "border-box",
        ...style,
      }}
    >
      <div
        style={{
          position: "relative",
          width: containerWidth,
          maxWidth: columnCount * (columnWidth + GUTTER) - GUTTER,
          margin: "0 auto",
          height: containerHeight,
        }}
      >
        {visibleItems.map((cell) => (
          <div
            key={cell._id}
            ref={(el) => measureItem(cell._id, el)}
            style={{
              position: "absolute",
              top: cell.top,
              left: cell.left,
              width: columnWidth,
              borderRadius: "var(--distance)",
              boxShadow: "0 2px 8px rgba(0,0,0,0.05)",
            }}
          >
            {/* ä¼ å…¥ remove æ–¹æ³•ç»™å¤–éƒ¨è°ƒç”¨ */}
            {renderItem(cell, {
              columnWidth,
              remove: () => removeItem(cell._id),
            })}
          </div>
        ))}
      </div>

      {isLoading && isInitialLoading && (
        <div style={{ textAlign: "center", padding: 48 }}>
          <Spin />
        </div>
      )}

      {!isLoading && allItems.length === 0 && !isInitialLoading && (
        <Empty style={{ marginTop: "20%" }} />
      )}

      {/* {!isLoading && !hasMore && allItems.length !== 0 && (
        <Divider plain>åˆ°åº•å•¦</Divider>
      )} */}

      {canManuallyLoadMore && (
        <div style={{ textAlign: "center", padding: 24 }}>
          <Button onClick={() => loadMore()}>åŠ è½½æ›´å¤š</Button>
        </div>
      )}
    </section>
  )
}
